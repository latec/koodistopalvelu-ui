<!DOCTYPE html>
<html>
<head>
  <!-- bootstrap :: the  first 3 must be first -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
  
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  
  <!-- angularjs -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-route.min.js"></script>
  
  <!-- ui-select files -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-select/0.14.1/select.min.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/angular-ui-select/0.14.1/select.min.css">
  
  <script>
  // Opintopolku / Koodisto Service:
  function getLanguageSpecificValue(fieldArray, fieldName, language) {
    if (fieldArray) {
      for (var i = 0; i < fieldArray.length; i++) {
        if (fieldArray[i].kieli === language) {
          var result = eval("fieldArray[i]." + fieldName);
          return result == null ? "" : result;
        }
      }
    }
    return "";
  }
  function getLanguageSpecificValueOrValidValue(fieldArray, fieldName, language) {
    var specificValue = getLanguageSpecificValue(fieldArray, fieldName, language);

    if (specificValue == "" && language != "FI"){
      specificValue = getLanguageSpecificValue(fieldArray, fieldName, "FI");
    }
    if (specificValue == "" && language != "SV"){
      specificValue = getLanguageSpecificValue(fieldArray, fieldName, "SV");
    }
    if (specificValue == "" && language != "EN"){
      specificValue = getLanguageSpecificValue(fieldArray, fieldName, "EN");
    }
    return specificValue;
  }
  </script>
  
  <title>Koodistot</title>
</head>
<body>
<div ng-app="koodiApp" ng-controller="koodiController" class="col-xs-12">
<div class="row">
  <div class="col-xs-12">
    <h1>Koodistot Opintopolussa</h1>
  </div>
</div>
<div class="row form-group">
  <div class="col-xs-7">
    <form role="form">
      <ui-select ng-model="koodistot.selected" on-select="useKoodisto($select.selected.arvo,$select.selected.versio)"
             theme="bootstrap" style="min-width: 300px; max-width: 100%;">
        <ui-select-match class="ui-select-match" placeholder="Etsi koodistoa">
        {{ $select.selected.selite }}
        <span class="fa fa-spinner fa-spin" ng-show="koodistoLataa"></span>
      </ui-select-match>
        <ui-select-choices repeat="o in koodistot | filter: $select.search">
          {{o.selite}}
        </ui-select-choices>
      </ui-select>
    </form>
  </div>
  <div class="col-xs-5">
    Koodistoja on {{koodistolkm}} kpl.
    <br>
    Valitun koodiston versio on {{koodistoversio}} ja koodien lkm {{koodistokoodilkm}}.
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <table width="96%" class="table table-striped table-condensed">
    <thead>
      <tr style="background-color:lightblue;">
        <th style="width:1%; vertical-align:top;">
        #
        </th>
        <th style="width:19%" ng-click="koodiOrderReverse=!(koodiOrder=='arvo'?koodiOrderReverse:true); koodiOrder='arvo'">
        Koodi
        <span class="fa fa-sort-down" ng-if="koodiOrder=='arvo' && !(koodiOrderReverse)"></span>
        <span class="fa fa-sort-up" ng-if="koodiOrder=='arvo' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:50%" ng-click="koodiOrderReverse=!(koodiOrder=='selite'?koodiOrderReverse:true); koodiOrder='selite'">
        Selite
        <span class="fa fa-sort-down" ng-if="koodiOrder=='selite' && !(koodiOrderReverse)"></span>
        <span class="fa fa-sort-up" ng-if="koodiOrder=='selite' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:15%" ng-click="koodiOrderReverse=!(koodiOrder=='alku'?koodiOrderReverse:true); koodiOrder='alku'">
        Alku
        <span class="fa fa-sort-down" ng-if="koodiOrder=='alku' && !(koodiOrderReverse)"></span>
        <span class="fa fa-sort-up" ng-if="koodiOrder=='alku' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:15%" ng-click="koodiOrderReverse=!(koodiOrder=='loppu'?koodiOrderReverse:true); koodiOrder='loppu'">
        Loppu
        <span class="fa fa-sort-down" ng-if="koodiOrder=='loppu' && !(koodiOrderReverse)"></span>
        <span class="fa fa-sort-up" ng-if="koodiOrder=='loppu' && (koodiOrderReverse)"></span>
        </th>
        <th ng-if="koodiLuokitus" style="width:1%;" ng-click="koodiOrderReverse=!(koodiOrder=='luokitus'?koodiOrderReverse:true); koodiOrder='luokitus'">
        Luokitus
        <span class="fa fa-sort-down" ng-if="koodiOrder=='luokitus' && !(koodiOrderReverse)"></span>
        <span class="fa fa-sort-up" ng-if="koodiOrder=='luokitus' && (koodiOrderReverse)"></span>
        </th>
        <th ng-if="koodiLuokitus" style="width:1%;" ng-click="koodiOrderReverse=!(koodiOrder=='luokitusselite'?koodiOrderReverse:true); koodiOrder='luokitusselite'">
        Luokitusselite
        <span class="fa fa-sort-down" ng-if="koodiOrder=='luokitusselite' && !(koodiOrderReverse)"></span>
        <span class="fa fa-sort-up" ng-if="koodiOrder=='luokitusselite' && (koodiOrderReverse)"></span>
        </th>
      </tr>
      <tr>
      <tr style="background-color:lightblue;">
        <td></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" ng-model="search['arvo']" /></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" ng-model="search['selite']" /></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" ng-model="search['alku']" /></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" ng-model="search['loppu']" /></td>
        <td ng-if="koodiLuokitus"><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" ng-model="search['luokitus']" /></td>
        <td ng-if="koodiLuokitus"><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" ng-model="search['luokitusselite']" /></td>
      </tr>
    </thead>
    <tbody>
      <tr ng-repeat="o in koodit | filter:search | orderBy:koodiOrder:koodiOrderReverse">
        <td style="background-color:#eeeeee;"><span style="font-size:xx-small;">{{$index+1}}</span></td>
        <td>{{o.arvo}}</td>
        <td>{{o.selite}}</td>
        <td>{{o.alku}}</td>
        <td>{{o.loppu}}</td>
        <td ng-if="koodiLuokitus">{{o.luokitus}}</td>
        <td ng-if="koodiLuokitus">{{o.luokitusselite}}</td>
      </tr>
    </tbody>
    </table>
  </div>
</div>
<div class="row">
  <div class="col-xs-4 text-left">
  </div>
  <div class="col-xs-4 text-center">
    <span style="font-family:arial; color:#757575;">&copy; Rapida 2017</span>
  </div>
  <div class="col-xs-4 text-right">
  </div>
</div>
<script>
  // Credits: http://stackoverflow.com/a/979325
  var sort_by = function(field, reverse, primer){
    var key = primer ? 
    function(x) {return primer(x[field])} : 
    function(x) {return x[field]};
    reverse = !reverse ? 1 : -1;
    return function (a, b) {
      return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
    } 
  }
</script>
<script>
var BASEURI = "https://testi.virkailija.opintopolku.fi/koodisto-service/rest";
var koodiApp = angular.module('koodiApp', ['ngRoute', 'ui.select']);
koodiApp.controller('koodiController', function($scope,$http)
{
  // koodistot:
  // - selite on valintalistassa näkyvä
  // - arvo on osa URIa eli koodiston tunniste opintopolussa
  // - versio on koodistoversio: 0=haetaan viimeisin, muuten pakottaa version
  $scope.koodistot = [];
  function fetchKoodistot() {
    console.log(new Date().toISOString()+" fetchKoodistot")
    //var uri = BASEURI+"/codeelement/codes/"+koodisto+"/"+koodistoversio;
    var uri = BASEURI+"/json";
    $http.get(uri).then(function (response){
      angular.forEach(response.data, function(robj,rkey){
        angular.forEach(robj.koodistos, function(kobj,kkey){
          var koodisto_onjo = 0;
          for(i in $scope.koodistot){
            var j = $scope.koodistot[i];
            if (j.arvo == kobj.koodistoUri){
              koodisto_onjo = 1;
              break;
            }
          }
          if(!koodisto_onjo) {
            var obj={};
            obj.versio = kobj.latestKoodistoVersio.versio;
            obj.arvo = kobj.koodistoUri;
            obj.selite = getLanguageSpecificValueOrValidValue(kobj.latestKoodistoVersio.metadata,"nimi","FI");
            $scope.koodistot.push(obj); // viedään löytynyt arvo näytille
            $scope.koodistolkm = $scope.koodistot.length;
            // järjestetään koodistolista
            $scope.koodistot.sort(sort_by('selite',false,function(a){return a.toUpperCase()}));
          }
        });
      });
      $scope.koodistoLataa = false;
      console.log(new Date().toISOString()+" fetchKoodistot $http.get done")
    });
    console.log(new Date().toISOString()+" fetchKoodistot DONE")
  }
  fetchKoodistot();
  
  $scope.koodit = [];
  $scope.koodistoversio = "-"; // näytettävä arvo (ei vaikuta hakuihin)
  $scope.koodistokoodilkm = "-";
  $scope.koodistoLataa = true;
  $scope.koodiOrder = 'arvo';
  $scope.koodiOrderReverse = false;
  
  $scope.koodiLuokitus = false;
  // koodistoluokitus
  // - ennaltamäärättyjen koodistojen yksi luokitteleva tieto
  // - todo: kaikki? automaattisesti?
  $scope.koodistoluokitus = [
    {"koodisto": "virtaarvosana", "luokitus": "virtaarvosanaasteikko"}
    ,{"koodisto": "kunta", "luokitus": "maakunta"}
    ,{"koodisto": "oppilaitosnumero", "luokitus": "oppilaitostyyppi"}
    ,{"koodisto": "koulutus", "luokitus": "koulutustyyppi"}
  ];
  
  // koodiarvojen hakeva ja asettava funktio
  function fetchKoodit(koodisto,koodistoversio) {
    console.log(new Date().toISOString()+" fetchKoodit: "+koodisto+" koodistoversio="+koodistoversio)
    if(!koodisto) return
    if(!koodistoversio) return
    $scope.koodistoversio = koodistoversio;
    $scope.koodistokoodilkm = 0;
    //var uri = BASEURI+"/codeelement/codes/"+koodisto+"/"+koodistoversio;
    var uri = BASEURI+"/json/"+koodisto+"/koodi"+"?koodistoVersio="+koodistoversio+"&onlyValidKoodis=false";
    $http.get(uri).then(function (response){
      angular.forEach(response.data, function(robj,rkey){
        var obj={};
        obj.selite = getLanguageSpecificValueOrValidValue(robj.metadata,"nimi","FI");
        obj.arvo = robj.koodiArvo;
        obj.alku = robj.voimassaAlkuPvm;
        obj.loppu = "";
        if (robj.voimassaLoppuPvm) { obj.loppu=robj.voimassaLoppuPvm; }
        $scope.koodiLuokitus = false;
        for(i in $scope.koodistoluokitus){
          if ($scope.koodistoluokitus[i].koodisto == koodisto){
            $scope.koodiLuokitus = true;
            $scope.koodistoLataa = true;
            
            var luokitus = $scope.koodistoluokitus[i].luokitus;
            var luri = BASEURI+"/json/relaatio/sisaltyy-alakoodit/"+robj.koodiUri;
            $http.get(luri).then(function (nextresponse){
              angular.forEach(nextresponse.data, function(lobj,lkey){
                //console.debug(new Date().toISOString()+" fetchKoodit: "+koodisto+" ("+obj.arvo+") luokitus "+lobj.koodiUri+" ("+lobj.koodisto.koodistoUri+" == "+luokitus+")")
                if (lobj.koodisto.koodistoUri == luokitus){
                  obj.luokitus = lobj.koodiUri;
                  obj.luokitusselite = getLanguageSpecificValueOrValidValue(lobj.metadata,"nimi","FI");
                  //console.debug(new Date().toISOString()+" fetchKoodit: "+koodisto+" ("+obj.arvo+") luokitus PUSH "+obj.luokitus)
                  // kloonataan obj uudeksi (ei korjata/muuteta referenssiä)
                  var tmp = [];
                  tmp.selite=obj.selite; tmp.arvo=obj.arvo; tmp.alku=obj.alku; tmp.loppu=obj.loppu;
                  tmp.luokitus=obj.luokitus; tmp.luokitusselite=obj.luokitusselite;
                  $scope.koodit.push(tmp); // viedään löytynyt arvo näytille
                  //$scope.koodit.push(obj); // viedään löytynyt arvo näytille
                  $scope.koodistokoodilkm++;
                }
              });
              $scope.koodistoLataa = false;
              //console.log(new Date().toISOString()+" fetchKoodit: "+koodisto+" luokitus $http.get done")
            });
          }
        }
        if (!$scope.koodiLuokitus){
          $scope.koodit.push(obj); // viedään löytynyt arvo näytille
          $scope.koodistokoodilkm++;
        }
      });
      $scope.koodistoLataa = false;
      console.log(new Date().toISOString()+" fetchKoodit: "+koodisto+" $http.get done")
    });
  }
  
  $scope.useKoodisto = function(arvo,versio) {
    console.log("useKoodisto: "+arvo+" "+versio)
    if(!arvo) return
    var koodisto = arvo;
    $scope.koodit = []; // tyhjätään taulukko
    $scope.koodistoversio = "-";
    $scope.koodistokoodilkm = "-";
    $scope.koodistoLataa = true;
    // varaudutaan koodistojen versiotietoihin.
    var koodistoversio = versio; // 0 palauttaa virhetilanteen. ilman koodistoversiota saisi viimeisimmän...
    if (koodistoversio==0) {
      // haetaan koodiston tiedot, jotta saadaan aito viimeisin koodiston versio
      var koodistouri = BASEURI+"/codes/"+koodisto;
      $http.get(koodistouri).then(function(koodistoresponse) {
        var data = koodistoresponse.data;
        koodistoversio = data.latestKoodistoVersio.versio;
        fetchKoodit(koodisto,koodistoversio);
      });
    } else {
      fetchKoodit(koodisto,koodistoversio);
    }
  }
  
});//-koodiController
</script>
</div><!-- /controller & /koodiApp -->
</body>
</html>
