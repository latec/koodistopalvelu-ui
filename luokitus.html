<!DOCTYPE html>
<html>
<head>
  <!-- bootstrap :: the  first 3 must be first -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- angularjs -->
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-route.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-sanitize.min.js"></script><!-- ui-select -->

  <!-- ui-select files -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-select/0.19.4/select.min.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/angular-ui-select/0.19.4/select.min.css">

  <!-- clipboardjs -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.12/clipboard.min.js"></script>

  <script>
  // Opintopolku / Koodisto Service:
  function getLanguageSpecificValue(fieldArray, fieldName, language) {
    if (fieldArray) {
      for (var i = 0; i < fieldArray.length; i++) {
        if (fieldArray[i].kieli === language) {
          var result = eval("fieldArray[i]." + fieldName);
          return result == null ? "" : result;
        }
      }
    }
    return "";
  }
  function getLanguageSpecificValueOrValidValue(fieldArray, fieldName, language) {
    var specificValue = getLanguageSpecificValue(fieldArray, fieldName, language);

    if (specificValue == "" && language != "FI"){
      specificValue = getLanguageSpecificValue(fieldArray, fieldName, "FI");
    }
    if (specificValue == "" && language != "SV"){
      specificValue = getLanguageSpecificValue(fieldArray, fieldName, "SV");
    }
    if (specificValue == "" && language != "EN"){
      specificValue = getLanguageSpecificValue(fieldArray, fieldName, "EN");
    }
    return specificValue;
  }
  </script>

  <style>
  .topright {
    position: absolute;
    right: 0px;
    top: 0px;
    display: inline-block;
  }
  #copyarea {
    -webkit-transition: all 0.30s ease-in-out;
    -moz-transition: all 0.30s ease-in-out;
    -ms-transition: all 0.30s ease-in-out;
    -o-transition: all 0.30s ease-in-out;
    outline: none;
    border: 1px solid lightblue;
  }
  #copyon:hover ~ #copyarea {
    border: 1px solid rgba(84,241,254,1);
    box-shadow:0 0 40px rgba(107,243,254,1);
  }
  </style>

  <title>Koodistot</title>
</head>
<body>
<div data-ng-app="koodiApp" data-ng-controller="koodiController" class="container-fluid">
<div class="row">
  <div class="col-xs-12">
    <h1>Koodistot Opintopolussa</h1>
  </div>
</div>
<div class="row form-group">
  <div class="col-xs-12 col-md-7 col-lg-4">
      <ui-select data-ng-model="koodistot.selected" on-select="useKoodisto($select.selected.arvo,$select.selected.versio)"
                 theme="bootstrap">
        <ui-select-match class="ui-select-match" placeholder="Etsi koodistoa">
          <span data-ng-bind="$select.selected.selite"></span>
        </ui-select-match>
        <ui-select-choices repeat="o in koodistot | filter: $select.search">
          <span data-ng-bind="o.selite"></span>
        </ui-select-choices>
      </ui-select>
  </div>
  <div class="col-xs-12 col-md-7 col-lg-4">
    <div class="row" data-ng-show="koodistot.selected && !koodistoLataa">
      <div class="col-xs-1">
        <select data-ng-model="relaatio" title="Valitse koodistojen relaatio">
          <option value="yla" title="Relaatio sisältyy">ylä</option>
          <option value="ala" title="Relaatio sisältää">ala</option>
          <option value="sama" title="Relaatio rinnasteinen">sama</option>
        </select>
      </div>
      <div class="col-xs-11">
        <ui-select data-ng-model="luokitukset.selected" on-select="useLuokitus($select.selected.arvo,$select.selected.versio)"
                   theme="bootstrap">
          <ui-select-match class="ui-select-match" placeholder="Etsi koodistoa luokitukseksi">
            <span data-ng-bind="$select.selected.selite"></span>
          </ui-select-match>
          <ui-select-choices repeat="o in koodistot | filter: $select.search">
            <span data-ng-bind="o.selite"></span>
          </ui-select-choices>
        </ui-select>
      </div>
    </div>
  </div>
  <div class="hidden-xs col-xs-12 col-md-5 col-lg-4">
    <select data-ng-model="opintopolku" data-ng-change="useOpintopolku(opintopolku)">
      <option value="testi">Testi/QA</option>
      <option value="tuotanto">Tuotanto</option>
    </select>
    Koodistoja {{koodistolkm}} kpl <a data-ng-click="fetchKoodistot()" class="fa fa-refresh" title="lataa uudelleen"></a>
    <br>
    <span class="small">valittu koodisto: versio={{koodistoversio}} tila={{koodistotila}} koodien lkm={{koodistokoodilkm}} koodiarvot {{koodistoonkonumero}}</span>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <div class="hidden-xs col-sm-1" id="copyon">
      <button class="clip rapida-clip" data-clipboard-target="#copyarea"
        data-popover-trigger="'mouseenter'" data-popover-placement="right" data-uib-popover="Kopioi taulukko leikepöydälle"
        data-popover-class="rapida-clip" data-tooltip-trigger="'focus'" data-tooltip-placement="top" data-uib-tooltip="Kopioitu!"
        data-ng-click="clipcopy=true" data-ng-mouseleave="clipcopy=false">
        <span class="glyphicon glyphicon-copy"></span>
      </button>
    </div>
    <div class="hidden-xs col-sm-10 text-center">
      <span class="fa fa-cog fa-spin fa-3x" data-ng-show="koodistoLataa || luokitusLataa"></span>
    </div>
    <!-- ei uutta row:ta, tai edes col:ia jotta taulukko on sisaruksena kopiointipainikkeelle! uusi div tiputtaa uudeksi riviksi -->
    <table width="96%" class="table table-striped table-condensed" id="copyarea">
    <thead>
      <tr style="background-color:lightblue;">
        <th data-ng-hide="clipcopy" style="width:1%; vertical-align:top;">
          #
        </th>
        <th style="width:10%" data-ng-click="koodiOrderReverse=!(koodiOrder=='arvo'?koodiOrderReverse:true); koodiOrder='arvo'">
          Koodi
          <span class="fa fa-sort-down" data-ng-show="koodiOrder=='arvo' && !(koodiOrderReverse)"></span>
          <span class="fa fa-sort-up" data-ng-show="koodiOrder=='arvo' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:35%" data-ng-click="koodiOrderReverse=!(koodiOrder=='selite'?koodiOrderReverse:true); koodiOrder='selite'">
          Selite
          <span class="fa fa-sort-down" data-ng-show="koodiOrder=='selite' && !(koodiOrderReverse)"></span>
          <span class="fa fa-sort-up" data-ng-show="koodiOrder=='selite' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:8%" data-ng-click="koodiOrderReverse=!(koodiOrder=='alku'?koodiOrderReverse:true); koodiOrder='alku'">
          Alku
          <span class="fa fa-sort-down" data-ng-show="koodiOrder=='alku' && !(koodiOrderReverse)"></span>
          <span class="fa fa-sort-up" data-ng-show="koodiOrder=='alku' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:8%" data-ng-click="koodiOrderReverse=!(koodiOrder=='loppu'?koodiOrderReverse:true); koodiOrder='loppu'">
          Loppu
          <span class="fa fa-sort-down" data-ng-show="koodiOrder=='loppu' && !(koodiOrderReverse)"></span>
          <span class="fa fa-sort-up" data-ng-show="koodiOrder=='loppu' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:9%;" data-ng-show="koodiLuokitus && !koodistoLataa"
         data-ng-click="koodiOrderReverse=!(koodiOrder=='luokitus'?koodiOrderReverse:true); koodiOrder='luokitus'">
          Luokitus
          <span class="fa fa-sort-down" data-ng-show="koodiOrder=='luokitus' && !(koodiOrderReverse)"></span>
          <span class="fa fa-sort-up" data-ng-show="koodiOrder=='luokitus' && (koodiOrderReverse)"></span>
        </th>
        <th style="width:30%;" data-ng-show="koodiLuokitus && !koodistoLataa"
         data-ng-click="koodiOrderReverse=!(koodiOrder=='luokitusselite'?koodiOrderReverse:true); koodiOrder='luokitusselite'">
          Luokitusselite
          <span class="fa fa-sort-down" data-ng-show="koodiOrder=='luokitusselite' && !(koodiOrderReverse)"></span>
          <span class="fa fa-sort-up" data-ng-show="koodiOrder=='luokitusselite' && (koodiOrderReverse)"></span>
        </th>
      </tr>
      <tr>
      <tr data-ng-hide="clipcopy" style="background-color:lightblue;">
        <td data-ng-hide="clipcopy"></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" data-ng-model="search['arvo']" /></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" data-ng-model="search['selite']" /></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" data-ng-model="search['alku']" /></td>
        <td><input type="text" class="form-control input-sm" style="background-color:#eeeeff;" data-ng-model="search['loppu']" /></td>
        <td data-ng-show="koodiLuokitus && !koodistoLataa">
          <input type="text" class="form-control input-sm" style="background-color:#eeeeff;" data-ng-model="search['luokitus']" />
        </td>
        <td data-ng-show="koodiLuokitus && !koodistoLataa">
          <input type="text" class="form-control input-sm" style="background-color:#eeeeff;" data-ng-model="search['luokitusselite']" />
        </td>
      </tr>
    </thead>
    <tbody>
      <tr data-ng-repeat="o in koodit | regex:search | orderBy:koodiOrder:koodiOrderReverse">
        <td data-ng-hide="clipcopy" style="background-color:#eeeeee;"><span style="font-size:xx-small;">{{$index+1}}</span></td>
        <td>{{o.arvo}}</td>
        <td>{{o.selite}}</td>
        <td>{{o.alku}}</td>
        <td>{{o.loppu}}</td>
        <td data-ng-show="koodiLuokitus && !koodistoLataa">{{o.luokitus}}</td>
        <td data-ng-show="koodiLuokitus && !koodistoLataa">{{o.luokitusselite}}</td>
      </tr>
    </tbody>
    </table>
  </div>
</div>
<div class="row">
  <div class="col-xs-4 text-left">
  </div>
  <div class="col-xs-4 text-center">
    <span style="font-family:arial; color:#757575;">&copy; Rapida 2017</span>
  </div>
  <div class="col-xs-4 text-right">
  </div>
</div>
<script>
// Credits: http://stackoverflow.com/a/979325
var sort_by = function(field, reverse, primer){
  var key = primer ? 
  function(x) {return primer(x[field])} : 
  function(x) {return x[field]};
  reverse = !reverse ? 1 : -1;
  return function (a, b) {
    return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
  } 
}
</script>
<script>
var koodiApp = angular.module('koodiApp', ['ngRoute', 'ui.select', 'ngSanitize']);
koodiApp.controller('koodiController', function($scope,$http)
{
  $scope.opintopolkuuris = {
    testi: "https://testi.virkailija.opintopolku.fi/koodisto-service/rest",
    tuotanto: "https://virkailija.opintopolku.fi/koodisto-service/rest"
  };
  $scope.opintopolku = "testi";
  $scope.opintopolkuuri = $scope.opintopolkuuris[$scope.opintopolku];
  $scope.relaatio = "yla";

  function reset() {
    $scope.koodit = [];
    $scope.kooditindex = {}; // indeksi koodit-arraylle
    $scope.koodisto = "-"; // näytettävä arvo (ei vaikuta hakuihin)
    $scope.koodistoversio = "-"; // näytettävä arvo (ei vaikuta hakuihin)
    $scope.koodistotila = "-"; // näytettävä arvo (ei vaikuta hakuihin)
    $scope.koodistokoodilkm = "-";
    $scope.koodistoLataa = true;
    $scope.koodistoonkonumero = "-";

    $scope.luokitukset = []; // tarkoituksella tässä! tyhjää valinnan koodistoa vaihdettaessa
    $scope.koodiLuokitus = false;
    $scope.luokitusLataa = false; // nb! eroaa koodistosta!
  }
  // aloita alusta (paitsi koodistojen lataus)
  function resetAll() {
    $scope.koodistot = []; // pitää olla array
    $scope.koodiOrder = 'arvo';
    $scope.koodiOrderReverse = false;
    $scope.kieli = 'FI';
    //$scope.query = "";
    reset();
  }

  // alusta kaikki
  resetAll();

  $scope.useOpintopolku = function (opintopolku) {
    if (opintopolku in $scope.opintopolkuuris) {
      console.log("useOpintopolku "+opintopolku)
      $scope.opintopolku = opintopolku;
      $scope.opintopolkuuri = $scope.opintopolkuuris[opintopolku];
      $scope.fetchKoodistot();
    }
  }

  // koodistot:
  // - selite on valintalistassa näkyvä
  // - arvo on osa URIa eli koodiston tunniste opintopolussa
  // - versio on koodistoversio: 0=haetaan viimeisin, muuten pakottaa version
  $scope.fetchKoodistot = function() {
    console.log("fetchKoodistot")
    $scope.koodistot = [];//pitää olla array
    let uri = $scope.opintopolkuuri+"/json";
    $http.get(uri).then(function (response){
      angular.forEach(response.data, function(robj,rkey){
        angular.forEach(robj.koodistos, function(kobj,kkey){
          // koodistot saattaa esiintyä useasti koodistoryhmien vuoksi
          let koodisto_onjo = 0;
          for(i in $scope.koodistot){
            var j = $scope.koodistot[i];
            if (j.arvo == kobj.koodistoUri){
              koodisto_onjo = 1;
              break;
            }
          }
          if(!koodisto_onjo) {
            var obj={};
            obj.versio = kobj.latestKoodistoVersio.versio;
            obj.arvo = kobj.koodistoUri;
            obj.selite = getLanguageSpecificValueOrValidValue(kobj.latestKoodistoVersio.metadata,"nimi","FI");
            $scope.koodistot.push(obj); // viedään löytynyt arvo näytille
            $scope.koodistolkm = $scope.koodistot.length;
            // järjestetään koodistolista
            $scope.koodistot.sort(sort_by('selite',false,function(a){return a.toUpperCase()}));
          }
        });
      });
      console.debug("fetchKoodistot $http.get done")
      $scope.koodistoLataa = false;
    });
  }

  // alusta koodistot ladatessa
  $scope.fetchKoodistot();

  /* pitäisi saada tietää jokin kutsu jolla nämä löytyy ilman että joka koodilla...
  function fetchLuokitukset(koodiUri) {
    console.log("fetchLuokitukset")
    if (!(robj.koodisto.koodistoUri in $scope.luokitukset)) {
      let uri = $scope.opintopolkuuri+"/json/relaatio/sisaltyy-alakoodit/"+koodiUri;
      $http.get(uri).then(function (response){
        angular.forEach(response.data, function(robj,rkey){
          var obj={};
          obj.versio = robj.versio;
          obj.arvo = robj.koodisto.koodistoUri;
          obj.selite = getLanguageSpecificValueOrValidValue(robj.metadata,"nimi","FI");
          $scope.luokitukset.push(obj); // viedään löytynyt arvo näytille
          // järjestetään koodistolista
          $scope.luokitukset.sort(sort_by('selite',false,function(a){return a.toUpperCase()}));
        });
        console.debug("fetchLuokitukset $http.get done")
      });
    }
  }
  */

  // koodiarvojen hakeva ja asettava funktio
  function fetchKoodit(koodisto,koodistoversio) {
    console.log("fetchKoodit: "+koodisto+" koodistoversio="+koodistoversio)
    if(!koodisto) return
    if(!koodistoversio) return
    $scope.koodistoversio = koodistoversio;
    $scope.koodistokoodilkm = 0;
    var uri = $scope.opintopolkuuri+"/json/"+koodisto+"/koodi"+"?koodistoVersio="+koodistoversio+"&onlyValidKoodis=false";
    $http.get(uri).then(function (response){
      // muutetaan arvot numeroiksi, mikäli *kaikki* arvot on sopivia
      var onkoarvonumero = true;
      $scope.koodistoonkonumero = "tekstinä";
      angular.forEach(response.data, function(robj,rkey){
        var obj={};
        obj.koodiUri = robj.koodiUri; // avain
        obj.selite = getLanguageSpecificValueOrValidValue(robj.metadata,"nimi","FI");
        obj.arvo = robj.koodiArvo;
        obj.alku = robj.voimassaAlkuPvm;
        obj.loppu = robj.voimassaLoppuPvm||"";
        $scope.koodit.push(obj);
        $scope.kooditindex[obj.koodiUri] = $scope.koodit.length-1;
        $scope.koodistokoodilkm++;
        if (onkoarvonumero) { // yksin ei numero riittää ja ei yritetä enää
          if (robj.koodiArvo.match(/^0/)) { // etunolla -> ei numero
            onkoarvonumero = false;
          } else if (!parseInt(robj.koodiArvo)) { // ei numero
            onkoarvonumero = false;
          } else if (robj.koodiArvo.match(/[^0-9]/)) { // ei numero
            onkoarvonumero = false;
          }
        }
        // haetaan alakoodit luokituksia varten
        /*
        $http.get($scope.opintopolkuuri+"/json/relaatio/sisaltyy-alakoodit/"+obj.koodiUri)
        .then(function(relasponse){
          angular.forEach(response.data, function(lobj,lkey){
            var kobj={};
            kobj.versio = lobj.versio;
            kobj.arvo = lobj.koodisto.koodistoUri;
            kobj.selite = getLanguageSpecificValueOrValidValue(lobj.metadata,"nimi","FI");
            if (!(kobj in $scope.luokitukset)) {
              $scope.luokitukset.push(kobj); // viedään löytynyt arvo näytille
              // järjestetään koodistolista
              $scope.luokitukset.sort(sort_by('selite',false,function(a){return a.toUpperCase()}));
            }
          });
        });
        */
      });
      if (onkoarvonumero) {
        $scope.koodistoonkonumero = "numeroina";
        for(var i=0; i<$scope.koodit.length; i++) {
          $scope.koodit[i].arvo = parseInt($scope.koodit[i].arvo);
        }
      }
      console.debug("fetchKoodit: "+koodisto+" $http.get done")
      $scope.koodistoLataa = false;
    });
  }

  $scope.useKoodisto = function(arvo,versio) {
    console.log("useKoodisto: "+arvo+" "+versio)
    if(!arvo) return
    reset();
    let koodisto = arvo;
    $scope.koodisto = arvo;
    // varaudutaan koodistojen versiotietoihin.
    let koodistoversio = versio; // 0 palauttaa virhetilanteen. ilman koodistoversiota saisi viimeisimmän...
    if (koodistoversio==0) {
      // haetaan koodiston tiedot, jotta saadaan aito viimeisin koodiston versio
      let koodistouri = $scope.opintopolkuuri+"/codes/"+koodisto;
      $http.get(koodistouri).then(function(koodistoresponse) {
        let data = koodistoresponse.data;
        koodistoversio = data.latestKoodistoVersio.versio;
        fetchKoodit(koodisto,koodistoversio);
      });
    } else {
      fetchKoodit(koodisto,koodistoversio);
    }
  }

  // tehdään erillinen objekti, jossa samat avaimet kuin koodit-objektissa
  $scope.useLuokitus = function(arvo,versio) {
    console.debug(new Date().toISOString(),"useLuokitus",arvo,versio)
    if(!arvo) return;
    if($scope.koodisto=="-") return;
    if(arvo == $scope.koodisto) return;
    let luokitus = arvo;

    // nollaa luokitus ja luokitusselite
    angular.forEach($scope.koodit,function(kobj,kkey){
      if ('luokitus' in kobj) {
        delete kobj.luokitus;
        delete kobj.luokitusselite;
      }
    });
    // hae luokitus-koodiston tiedot (koodi arvot ja selitteet)
    let uri = $scope.opintopolkuuri+"/json/"+luokitus+"/koodi"+"?koodistoVersio="+versio+"&onlyValidKoodis=false";
    $http.get(uri).then(function(response){
      $scope.koodiLuokitus = true; // näytä sarakkeet
      $scope.luokitusLataa = true; // näytä spinneri
      $scope.luokituskoodilkm = response.data.length;
      $scope.luokitusladattulkm = 0;
      angular.forEach(response.data, function(lobj,lkey){
        // haetaan luokituksen ylä-/ala-koodit!
        let relaatiouri = "/json/relaatio/sisaltyy-ylakoodit/";
        if ($scope.relaatio=='ala') {
          relaatiouri = "/json/relaatio/sisaltyy-alakoodit/";
        } else if ($scope.relaatio=='sama') {
          relaatiouri = "/json/relaatio/rinnasteinen/";
        }
        let luri = $scope.opintopolkuuri+relaatiouri+lobj.koodiUri;
        $http.get(luri).then(function(nextresponse){
          angular.forEach(nextresponse.data, function(robj,rkey){
            // onko oikean koodiston JA LUONNOS-tilainen (kun tulee kaikki versiot mukaan)
            if (robj.koodisto.koodistoUri == $scope.koodisto && robj.tila=="LUONNOS") {
              if ('luokitus' in $scope.koodit[$scope.kooditindex[robj.koodiUri]]) {
                if ($scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitus.indexOf("*")<0) { // ei vielä duplikaatti
                  $scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitus = "**"; // nyt siis duplikaatti
                } else if ($scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitus.indexOf("*")==0) { // on jo
                  $scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitus += "*";
                }
                $scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitusselite = $scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitus;
              } else {
                $scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitus = lobj.koodiArvo;
                $scope.koodit[$scope.kooditindex[robj.koodiUri]].luokitusselite = getLanguageSpecificValueOrValidValue(lobj.metadata,"nimi","FI");
              }
            }
          });
          console.debug(new Date().toISOString(),"useLuokitus",luokitus,$scope.luokitusladattulkm,lobj.koodiUri,"$http.get done")
          $scope.luokitusladattulkm++;
          if ($scope.luokitusladattulkm >= $scope.luokituskoodilkm) {
            $scope.luokitusLataa = false; // piilota spinneri
            console.debug(new Date().toISOString(),"useLuokitus",luokitus,$scope.luokitusladattulkm,"$http.get ALL DONE")
          }
        });
      });
      //console.debug(new Date().toISOString(),"useLuokitus",luokitus,"$http.get done")
    });
  }

});//-koodiController

// Regular Expression filtering
koodiApp.filter('regex', function() {
  return function(input, regex) {
    //console.debug(input)
    if(!regex) return input;
    //console.debug(regex,Object.keys(regex).length,angular.equals({},regex))
    // clear empty strings away
    angular.forEach(regex,function(value,field){
      if(value==""){
        delete regex[field];
      }
    });
    if(angular.equals({},regex)){//nothing to rule out..
      return input;//..so return all
    }
    // else...
    // start finding matches
    var out = [];
    for(var i=0; i<input.length; i++){
      var addit=true;//see if all patterns give ok
      angular.forEach(regex,function(value,field){
        var patt = new RegExp(value,'i');
        if(!patt.test(input[i][field])){ //if even one says no..
          addit=false;//..it's a no!
        }
      });
      if(addit){
        out.push(input[i]);
      }
    }
    return out;
  };
});

var clipboard = new Clipboard('.clip');
clipboard.on('success', function(e) {
  e.clearSelection();
});
clipboard.on('error', function(e) {
  console.log(e);
});

</script>
</div><!-- /controller & /koodiApp -->
</body>
</html>
